<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Cat ç®¡ç†ç³»ç»Ÿ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
        .container { max-width: 600px; margin: 40px auto; background: #fff; padding: 24px; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
        h2 { text-align: center; }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 4px; }
        input[type=text], input[type=password], input[type=number] { width: 100%; padding: 8px; box-sizing: border-box; }
        button { padding: 8px 16px; margin-right: 8px; }
        table { width: 100%; border-collapse: collapse; margin-top: 24px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #f0f0f0; }
        .error { color: #d00; margin-bottom: 12px; }
        .actions button { margin-right: 4px; }
        .logout { float: right; }
    </style>
</head>
<body>
<div class="container" id="app">
    <div id="login-view">
        <h2>ç™»å½•</h2>
        <div class="error" id="login-error"></div>
        <div class="form-group">
            <label for="login-username">ç”¨æˆ·å</label>
            <input type="text" id="login-username" name="login-username">
        </div>
        <div class="form-group">
            <label for="login-password">å¯†ç </label>
            <input type="password" id="login-password" name="login-password">
        </div>
        <button onclick="login()">ç™»å½•</button>
    </div>
    <div id="cat-view" style="display:none;">
        <h2>Cat åˆ—è¡¨ <button class="logout" onclick="logout()">é€€å‡º</button></h2>
        <div class="error" id="cat-error"></div>
        <table>
            <thead>
            <tr><th>ID</th><th>åå­—</th><th>å¹´é¾„</th><th>å“ç§</th><th>æ€§åˆ«</th><th>ä½“é‡</th><th>é¢œè‰²</th><th>æè¿°</th></tr>
            </thead>
            <tbody id="cat-list"></tbody>
        </table>
    </div>
    <nav style="margin-bottom:24px;">
        <button onclick="switchView('home')">é¦–é¡µ</button>
        <button onclick="switchView('article')">èµ„è®¯ä¸­å¿ƒ</button>
        <button onclick="switchView('encyclopedia')">å® ç‰©ç™¾ç§‘</button>
        <button onclick="switchView('community')">ç¤¾åŒºäº’åŠ¨</button>
        <button onclick="switchView('service')">æœåŠ¡ä¸èµ„æº</button>
        <button onclick="switchView('member')">ä¼šå‘˜ä¸­å¿ƒ</button>
        <button class="logout" onclick="logout()">é€€å‡º</button>
    </nav>
    <div id="home-view" style="display:none;">
        <h2>ğŸ¾ å® ç‰©ä¹‹å®¶</h2>
        <div>æ¬¢è¿æ¥åˆ°å® ç‰©ä¹‹å®¶ï¼è¿™é‡Œæœ‰æœ€æ–°çš„å® ç‰©èµ„è®¯ã€ç™¾ç§‘ã€ç¤¾åŒºäº’åŠ¨å’Œä¸°å¯Œçš„æœåŠ¡èµ„æºã€‚</div>
        <div style="margin-top:20px;">
            <b>æ¨èæ–‡ç« ï¼š</b>
            <ul id="home-articles"></ul>
        </div>
        <div style="margin-top:20px;">
            <b>çƒ­é—¨å® ç‰©ï¼š</b>
            <ul id="home-cats"></ul>
        </div>
    </div>
    <div id="article-view" style="display:none;">
        <h2>èµ„è®¯ä¸­å¿ƒ</h2>
        <div id="article-list"></div>
    </div>
    <div id="encyclopedia-view" style="display:none;">
        <h2>å® ç‰©ç™¾ç§‘</h2>
        <div id="encyclopedia-list"></div>
    </div>
    <div id="community-view" style="display:none;">
        <h2>ç¤¾åŒºäº’åŠ¨</h2>
        <div id="community-list"></div>
    </div>
    <div id="service-view" style="display:none;">
        <h2>æœåŠ¡ä¸èµ„æº</h2>
        <div id="service-list"></div>
    </div>
    <div id="member-view" style="display:none;">
        <h2>ä¼šå‘˜ä¸­å¿ƒ</h2>
        <div id="member-info"></div>
        <div id="member-favorites"></div>
        <div id="member-score"></div>
    </div>
</div>
<script>
const API_BASE = '';

function show(view) {
    document.getElementById('login-view').style.display = view === 'login' ? '' : 'none';
    document.getElementById('cat-view').style.display = view === 'cat' ? '' : 'none';
    // æ–°å¢ï¼šåˆ‡æ¢å® ç‰©ä¹‹å®¶å¤šæ¨¡å—é¡µé¢
    const views = ['home', 'article', 'encyclopedia', 'community', 'service', 'member'];
    views.forEach(v => {
        const el = document.getElementById(v + '-view');
        if (el) el.style.display = view === v ? '' : 'none';
    });
}

function getToken() {
    return localStorage.getItem('token') || '';
}

function setToken(token) {
    if (token) localStorage.setItem('token', token);
    else localStorage.removeItem('token');
}

function showError(id, msg) {
    document.getElementById(id).textContent = msg || '';
}

function login() {
    showError('login-error', '');
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;
    fetch(API_BASE + '/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
    })
    .then(r => r.json().then(data => ({ok: r.ok, data})))
    .then(res => {
        if (res.ok && res.data.token) {
            setToken(res.data.token);
            show('cat');
            loadCats();
        } else {
            showError('login-error', res.data.error || 'ç™»å½•å¤±è´¥');
        }
    })
    .catch(() => showError('login-error', 'ç½‘ç»œé”™è¯¯'));
}

function logout() {
    setToken('');
    show('login');
}

function loadCats() {
    showError('cat-error', '');
    fetch(API_BASE + '/cats', {
        headers: { 'Authorization': 'Bearer ' + getToken() }
    })
    .then(r => r.json().then(data => ({ok: r.ok, data})))
    .then(res => {
        if (res.ok) {
            renderCatList(res.data);
        } else {
            showError('cat-error', res.data.error || 'åŠ è½½å¤±è´¥');
            if (res.data.error && res.data.error.includes('token')) logout();
        }
    })
    .catch(() => showError('cat-error', 'ç½‘ç»œé”™è¯¯'));
}

function renderCatList(cats) {
    const list = document.getElementById('cat-list');
    list.innerHTML = '';
    cats.forEach(cat => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${cat.id}</td><td>${cat.name}</td><td>${cat.age}</td>
            <td>${cat.breed || ''}</td><td>${cat.gender || ''}</td><td>${cat.weight || ''}</td>
            <td>${cat.color || ''}</td><td>${cat.description || ''}</td>`;
        list.appendChild(tr);
    });
}

function loadArticles() {
    fetch(API_BASE + '/articles', { headers: { 'Authorization': 'Bearer ' + getToken() } })
        .then(r => r.json())
        .then(data => {
            const div = document.getElementById('article-list');
            div.innerHTML = '<ul>' + (data || []).map(a =>
                `<li><b>${a.title}</b> [${a.category}]<br>${a.content}</li>`
            ).join('') + '</ul>';
        });
}
// å® ç‰©ç™¾ç§‘
function loadEncyclopedias() {
    fetch(API_BASE + '/encyclopedias', { headers: { 'Authorization': 'Bearer ' + getToken() } })
        .then(r => r.json())
        .then(data => {
            const div = document.getElementById('encyclopedia-list');
            div.innerHTML = '<ul>' + (data || []).map(e => `<li><b>${e.title}</b> [${e.type}]<br>${e.content}</li>`).join('') + '</ul>';
        });
}
// ç¤¾åŒºäº’åŠ¨
function loadCommunity() {
    fetch(API_BASE + '/posts', { headers: { 'Authorization': 'Bearer ' + getToken() } })
        .then(r => r.json())
        .then(data => {
            const div = document.getElementById('community-list');
            div.innerHTML = '<ul>' + (data || []).map(p => `<li><b>ç”¨æˆ·${p.userId}</b> [${p.type}]<br>${p.content}</li>`).join('') + '</ul>';
        });
}
// æœåŠ¡ä¸èµ„æº
function loadService() {
    fetch(API_BASE + '/hospitals', { headers: { 'Authorization': 'Bearer ' + getToken() } })
        .then(r => r.json())
        .then(data => {
            const div = document.getElementById('service-list');
            div.innerHTML = '<b>å® ç‰©åŒ»é™¢ï¼š</b><ul>' + (data || []).map(h => `<li><b>${h.name}</b> ${h.address} ${h.phone} è¯„åˆ†:${h.rating || '-'}<br>${h.description}</li>`).join('') + '</ul>';
        });
}
// ä¼šå‘˜ä¸­å¿ƒ
function loadMember() {
    const username = localStorage.getItem('username');
    if (!username) return;
    fetch(API_BASE + '/users/' + username, { headers: { 'Authorization': 'Bearer ' + getToken() } })
        .then(r => r.json())
        .then(user => {
            document.getElementById('member-info').innerHTML = `<b>ç”¨æˆ·åï¼š</b>${user.username}<br><b>ç§¯åˆ†ï¼š</b>${user.score || 0}<br><b>è¾¾äººç§°å·ï¼š</b>${user.role || ''}`;
        });
    fetch(API_BASE + '/users/' + username + '/favorites', { headers: { 'Authorization': 'Bearer ' + getToken() } })
        .then(r => r.json())
        .then(favs => {
            document.getElementById('member-favorites').innerHTML = '<b>æ”¶è—ï¼š</b>' + (favs && favs.length ? favs.join(', ') : 'æ— ');
        });
}

// é¦–é¡µæ¨èæ–‡ç« å’Œçƒ­é—¨å® ç‰©åŠ è½½
function loadHomeArticles() {
    fetch(API_BASE + '/articles', { headers: { 'Authorization': 'Bearer ' + getToken() } })
        .then(r => r.json())
        .then(data => {
            const ul = document.getElementById('home-articles');
            ul.innerHTML = '';
            (data || []).slice(0, 5).forEach(a => {
                const li = document.createElement('li');
                li.textContent = a.title;
                ul.appendChild(li);
            });
        });
    // çƒ­é—¨å® ç‰©
    fetch(API_BASE + '/cats', { headers: { 'Authorization': 'Bearer ' + getToken() } })
        .then(r => r.json())
        .then(data => {
            const ul = document.getElementById('home-cats');
            ul.innerHTML = '';
            (data || []).slice(0, 5).forEach(c => {
                const li = document.createElement('li');
                li.textContent = c.name + (c.breed ? 'ï¼ˆ' + c.breed + 'ï¼‰' : '');
                ul.appendChild(li);
            });
        });
}

// åˆ‡æ¢è§†å›¾
window.switchView = (view) => {
    show(view);
    // æ ¹æ®ä¸åŒviewåŠ è½½å¯¹åº”æ•°æ®
    if (view === 'home') {
        loadHomeArticles();
        // å¯æ‰©å±•ï¼šåŠ è½½çƒ­é—¨å® ç‰©
    } else if (view === 'article') {
        loadArticles && loadArticles();
    } else if (view === 'encyclopedia') {
        loadEncyclopedias && loadEncyclopedias();
    } else if (view === 'community') {
        loadCommunity && loadCommunity();
    } else if (view === 'service') {
        loadService && loadService();
    } else if (view === 'member') {
        loadMember && loadMember();
    }
}

// ï¿½ï¿½ï¿½åŠ¨ç™»å½•æ€åˆ¤æ–­
window.onload = function() {
    if (getToken()) {
        // ç™»å½•åé»˜è®¤è¿›å…¥é¦–é¡µ
        show('home');
        switchView('home');
    } else {
        show('login');
    }
}
</script>
</body>
</html>
